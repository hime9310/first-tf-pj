version: 0.2

# ç¯å¢ƒå˜é‡
env:
  variables:
    APP_NAME: "my-python-app"
    PYTHON_VERSION: "3.9"
    
phases:
  install:
    runtime-versions:
      python: 3.9
    commands:
      - echo "ğŸ”§ Installing build dependencies..."
      - pip3 install --upgrade pip setuptools wheel
      - echo "Python version:" $(python3 --version)
      - echo "Pip version:" $(pip3 --version)
      
  pre_build:
    commands:
      - echo "ğŸ” Pre-build phase started on $(date)"
      - echo "Current directory:" $(pwd)
      - echo "Files in directory:" $(ls -la)
      
      # è¯­æ³•æ£€æŸ¥
      - echo "ğŸ§ª Checking Python syntax..."
      - python3 -m py_compile app.py
      - echo "âœ… Syntax check passed"
      
      # å®‰è£…ä¾èµ–ï¼ˆå¦‚æœæœ‰requirements.txtï¼‰
      - |
        if [ -f "requirements.txt" ]; then
          echo "ğŸ“¦ Installing Python dependencies..."
          pip3 install -r requirements.txt
          echo "âœ… Dependencies installed"
        else
          echo "â„¹ï¸ No requirements.txt found, skipping dependency installation"
        fi
      
  build:
    commands:
      - echo "ğŸ—ï¸ Build phase started on $(date)"
      
      # è¿è¡Œæµ‹è¯•ï¼ˆå¦‚æœæœ‰ï¼‰
      - echo "ğŸ§ª Running tests..."
      - |
        if [ -f "test_app.py" ]; then
          python3 -m pytest test_app.py -v
          echo "âœ… Tests passed"
        else
          echo "â„¹ï¸ No tests found, skipping test execution"
        fi
      
      # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
      - echo "ğŸ“ Creating version info..."
      - echo "{\"build_time\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",\"commit\":\"$CODEBUILD_RESOLVED_SOURCE_VERSION\"}" > version.json
      
      - echo "âœ… Build phase completed successfully"
      
  post_build:
    commands:
      - echo "ğŸ“¤ Post-build phase started on $(date)"
      - echo "ğŸ¯ Preparing deployment artifacts..."
      - echo "ğŸ“ Final directory contents:"
      - ls -la
      - echo "âœ… Post-build phase completed"

# æ„å»ºäº§ç‰©
artifacts:
  files:
    - '**/*'
  name: $APP_NAME-build-$(date +%Y%m%d-%H%M%S)
  
# ç¼“å­˜ï¼ˆå¯é€‰ï¼ŒåŠ é€Ÿæ„å»ºï¼‰
cache:
  paths:
    - '/root/.cache/pip/**/*'