# 🔍 EC2 部署后应用程序检查指南

## 📋 检查清单概览

部署完成后，按以下顺序进行检查：

```
✅ 1. 基础连接检查 (30秒)
✅ 2. 服务状态检查 (1分钟)  
✅ 3. 应用功能检查 (2分钟)
✅ 4. 性能和稳定性检查 (5分钟)
✅ 5. 日志和监控检查 (3分钟)
```

---

## 🚀 第1步：基础连接检查

### 1.1 检查 EC2 实例状态
```bash
# 在 AWS 控制台检查：
# EC2 > 实例 > 选择你的实例
# 实例状态：running ✅
# 状态检查：2/2 checks passed ✅
```

### 1.2 SSH 连接测试
```bash
# 测试能否连接到服务器
ssh -i your-key.pem ubuntu@your-ec2-ip

# 成功连接后会看到：
# Welcome to Ubuntu 20.04.x LTS (GNU/Linux ...)
# ubuntu@ip-xxx-xxx-xxx-xxx:~$
```

### 1.3 网络端口检查
```bash
# 在服务器上检查端口 8000 是否开放
netstat -tuln | grep 8000

# 期待结果：
# tcp        0      0 0.0.0.0:8000            0.0.0.0:*               LISTEN

# 如果没有结果，说明应用程序没有启动
```

---

## ⚙️ 第2步：服务状态检查

### 2.1 检查 systemd 服务状态
```bash
# 查看应用程序服务状态
sudo systemctl status my-python-app

# ✅ 正常状态应该显示：
# ● my-python-app.service - CodePipeline Demo Python Application
#    Loaded: loaded (/etc/systemd/system/my-python-app.service; enabled; vendor preset: enabled)
#    Active: active (running) since Wed 2025-01-15 10:30:00 UTC; 15min ago
#    Main PID: 12345 (python3)
#    Memory: 25.2M
#    CGroup: /system.slice/my-python-app.service
#            └─12345 /usr/bin/python3 /opt/my-python-app/sampl-app.py
```

**状态说明：**
- `Active: active (running)` ✅ = 服务正在运行
- `Active: inactive (dead)` ❌ = 服务已停止
- `Active: failed` ❌ = 服务启动失败

### 2.2 检查进程是否存在
```bash
# 查找 Python 应用程序进程
ps aux | grep sampl-app.py

# ✅ 正常结果：
# ubuntu   12345  0.1  2.3  45678  12345 ?  S  10:30  0:05 python3 /opt/my-python-app/sampl-app.py

# ❌ 如果没有结果，说明进程不存在
```

### 2.3 检查服务自启动设置
```bash
# 检查服务是否设置为开机自启
sudo systemctl is-enabled my-python-app

# ✅ 期待结果：enabled
# ❌ 如果显示 disabled，需要启用自启动
```

---

## 🌐 第3步：应用功能检查

### 3.1 本地访问测试（在 EC2 服务器上）
```bash
# 测试主页面
curl http://localhost:8000/

# ✅ 期待结果（JSON 格式）：
{
  "message": "Hello World from CodePipeline!",
  "timestamp": "2025-01-15T10:45:00.000Z",
  "version": "1.0.2",
  "environment": "production",
  "hostname": "ip-172-31-32-123",
  "status": "success",
  "deployment_info": {
    "deployed_at": "2025-01-15 10:29:45",
    "python_version": "3.9",
    "platform": "posix",
    "build_time": "2025-01-15T10:28:30Z",
    "commit": "abc123def456"
  }
}
```

### 3.2 健康检查测试
```bash
# 测试健康检查接口
curl http://localhost:8000/health

# ✅ 期待结果：
{
  "status": "healthy",
  "timestamp": "2025-01-15T10:45:00.000Z",
  "uptime": 900.5
}
```

### 3.3 外网访问测试（从你的电脑）
```bash
# 从本地电脑测试（替换为你的 EC2 公网 IP）
curl http://your-ec2-public-ip:8000/

# 或者在浏览器中打开：
# http://your-ec2-public-ip:8000/
```

**如果外网访问失败，检查：**
```bash
# 1. AWS 安全组设置
# EC2 控制台 > 安全组 > 入站规则
# 确保有：类型=自定义TCP，端口=8000，源=0.0.0.0/0

# 2. 服务器防火墙
sudo ufw status
# 如果启用了防火墙，添加规则：
sudo ufw allow 8000
```

### 3.4 错误处理测试
```bash
# 测试不存在的页面
curl http://localhost:8000/nonexistent

# ✅ 期待结果（404 错误）：
{
  "error": "Not Found",
  "message": "Path /nonexistent not found",
  "available_endpoints": ["/", "/health"]
}
```

---

## 📊 第4步：性能和稳定性检查

### 4.1 响应时间测试
```bash
# 测试响应时间
time curl -s http://localhost:8000/ > /dev/null

# ✅ 正常响应时间应该在 0.1-1.0 秒内
# real    0m0.234s
# user    0m0.012s
# sys     0m0.008s
```

### 4.2 连续请求测试
```bash
# 连续发送 10 个请求，检查稳定性
for i in {1..10}; do
  echo "请求 $i:"
  curl -s http://localhost:8000/ | grep -o '"status":"[^"]*"'
  sleep 1
done

# ✅ 每次都应该返回：
# "status":"success"
```

### 4.3 并发测试（可选）
```bash
# 如果安装了 Apache Bench
sudo apt install apache2-utils

# 运行简单的并发测试
ab -n 50 -c 5 http://localhost:8000/

# 查看关键指标：
# - Complete requests: 50 ✅
# - Failed requests: 0 ✅
# - Requests per second: > 10 ✅
```

### 4.4 内存使用检查
```bash
# 检查应用程序内存使用
ps -o pid,ppid,cmd,%mem,%cpu --sort=-%mem | grep sampl-app.py

# ✅ 内存使用应该 < 5%（在 1GB 内存的服务器上）
```

---

## 📝 第5步：日志和监控检查

### 5.1 系统日志检查
```bash
# 查看最近的系统日志
sudo journalctl -u my-python-app -n 20

# ✅ 正常日志示例：
# Jan 15 10:30:00 ip-xxx systemd[1]: Started CodePipeline Demo Python Application.
# Jan 15 10:30:00 ip-xxx python3[12345]: [2025-01-15T10:30:00.000Z] 服务器开始运行
# Jan 15 10:30:01 ip-xxx python3[12345]: [2025-01-15T10:30:01.000Z] 127.0.0.1 - - "GET / HTTP/1.1" 200 -

# ❌ 错误日志示例：
# Jan 15 10:30:00 ip-xxx python3[12345]: Traceback (most recent call last):
# Jan 15 10:30:00 ip-xxx python3[12345]: FileNotFoundError: [Errno 2] No such file or directory
```

### 5.2 应用程序日志检查
```bash
# 查看应用程序日志文件
tail -20 /var/log/my-python-app/app.log

# ✅ 正常日志内容：
# [2025-01-15T10:30:00.000Z] 服务器开始运行
# [2025-01-15T10:30:01.000Z] GET / 200
# [2025-01-15T10:30:02.000Z] GET /health 200

# 查看错误日志
tail -20 /var/log/my-python-app/error.log

# ✅ 如果没有错误，文件可能为空或不存在
```

### 5.3 实时日志监控
```bash
# 实时监控系统日志
sudo journalctl -u my-python-app -f

# 在另一个终端窗口测试访问：
curl http://localhost:8000/

# 应该能看到实时的访问日志
```

---

## 🚨 常见问题快速诊断

### 问题1：无法访问应用程序
```bash
# 症状：curl: (7) Failed to connect to localhost port 8000: Connection refused

# 诊断步骤：
echo "=== 诊断开始 ==="

# 1. 检查服务状态
echo "1. 服务状态："
sudo systemctl is-active my-python-app

# 2. 检查端口
echo "2. 端口状态："
netstat -tuln | grep 8000

# 3. 检查进程
echo "3. 进程状态："
ps aux | grep sampl-app.py | grep -v grep

echo "=== 诊断结束 ==="
```

### 问题2：服务启动失败
```bash
# 症状：systemctl status 显示 failed

# 快速修复脚本：
echo "=== 修复开始 ==="

# 1. 停止服务
sudo systemctl stop my-python-app

# 2. 检查文件权限
sudo chown ubuntu:ubuntu /opt/my-python-app/sampl-app.py
sudo chmod +x /opt/my-python-app/sampl-app.py

# 3. 手动测试
echo "手动测试应用程序："
cd /opt/my-python-app
timeout 5s python3 sampl-app.py || echo "应用程序启动失败"

# 4. 重启服务
sudo systemctl start my-python-app
sudo systemctl status my-python-app

echo "=== 修复结束 ==="
```

### 问题3：外网无法访问
```bash
# 症状：本地可以访问，外网不行

# 检查网络配置：
echo "=== 网络诊断 ==="

# 1. 检查防火墙
echo "1. 防火墙状态："
sudo ufw status

# 2. 检查监听地址
echo "2. 监听地址："
netstat -tuln | grep 8000

# 3. 测试本地访问
echo "3. 本地访问测试："
curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/

echo "=== 请检查 AWS 安全组设置 ==="
```

---

## 📋 完整检查脚本

创建一个自动化检查脚本：

```bash
# 创建检查脚本
cat << 'EOF' > /home/ubuntu/check_app.sh
#!/bin/bash

echo "🔍 开始检查应用程序状态..."
echo "=================================="

# 1. 服务状态检查
echo "1️⃣ 服务状态检查："
if systemctl is-active --quiet my-python-app; then
    echo "   ✅ 服务正在运行"
else
    echo "   ❌ 服务未运行"
    exit 1
fi

# 2. 端口检查
echo "2️⃣ 端口检查："
if netstat -tuln | grep -q ":8000"; then
    echo "   ✅ 端口 8000 正在监听"
else
    echo "   ❌ 端口 8000 未开放"
    exit 1
fi

# 3. HTTP 响应检查
echo "3️⃣ HTTP 响应检查："
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/)
if [ "$HTTP_CODE" = "200" ]; then
    echo "   ✅ HTTP 响应正常 (状态码: $HTTP_CODE)"
else
    echo "   ❌ HTTP 响应异常 (状态码: $HTTP_CODE)"
    exit 1
fi

# 4. 健康检查
echo "4️⃣ 健康检查："
HEALTH_STATUS=$(curl -s http://localhost:8000/health | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
if [ "$HEALTH_STATUS" = "healthy" ]; then
    echo "   ✅ 健康检查通过"
else
    echo "   ❌ 健康检查失败"
    exit 1
fi

# 5. 内存使用检查
echo "5️⃣ 资源使用检查："
MEMORY_USAGE=$(ps -o %mem --no-headers -C python3 | head -1 | xargs)
echo "   📊 内存使用: ${MEMORY_USAGE}%"

# 6. 运行时间检查
echo "6️⃣ 运行时间检查："
UPTIME=$(curl -s http://localhost:8000/health | grep -o '"uptime":[^,}]*' | cut -d':' -f2)
echo "   ⏱️ 运行时间: ${UPTIME} 秒"

echo "=================================="
echo "🎉 所有检查通过！应用程序运行正常。"

# 显示访问信息
PUBLIC_IP=$(curl -s http://169.254.169.254/latest/meta-data/public-ipv4)
echo ""
echo "🌐 访问地址："
echo "   本地: http://localhost:8000/"
echo "   外网: http://${PUBLIC_IP}:8000/"
echo "   健康检查: http://${PUBLIC_IP}:8000/health"

EOF

# 设置执行权限
chmod +x /home/ubuntu/check_app.sh

# 运行检查
/home/ubuntu/check_app.sh
```

---

## 🎯 检查结果判断

### ✅ 应用程序正常的标志：
- systemctl status 显示 `active (running)`
- 端口 8000 正在监听
- HTTP 请求返回状态码 200
- 健康检查返回 `"status": "healthy"`
- 日志中没有错误信息
- 内存使用合理（< 100MB）

### ❌ 需要注意的异常：
- 服务状态为 `failed` 或 `inactive`
- 端口 8000 未开放
- HTTP 请求超时或返回错误状态码
- 健康检查失败
- 日志中出现 ERROR 或 Exception
- 内存使用过高

### 📞 获取帮助：
如果遇到问题，可以：
1. 查看详细的错误日志：`sudo journalctl -u my-python-app -n 50`
2. 参考 [使用说明_中文版.md](./使用说明_中文版.md) 的故障排除部分
3. 运行自动检查脚本获取详细诊断信息

---

**记住：部署成功后，应用程序应该能够在几分钟内正常响应。如果超过 10 分钟仍有问题，建议检查部署日志和配置。**